<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pair Chat ‚Äî E2E, Images, TTL</title>
  <style>
    :root { --bg:#0f1220; --card:#171a2b; --text:#eef1ff; --muted:#aab0d6;
            --accent:#5c7cfa; --accent2:#748ffc; --danger:#ff6b6b; --ok:#51cf66;
            --shadow:0 10px 30px rgba(0,0,0,.35); }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
         background:radial-gradient(1200px 600px at 20% -10%,rgba(92,124,250,.18),transparent),
                    radial-gradient(1000px 500px at 100% 0,rgba(116,143,252,.14),transparent),var(--bg);
         color:var(--text)}
    .container{max-width:860px;margin:40px auto;padding:0 16px}
    h1{margin:0 0 20px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:18px;margin:16px 0;box-shadow:var(--shadow)}
    .hint{margin:8px 0 0;color:var(--muted);font-style:italic}
    .code{font-family:ui-monospace,Menlo,Consolas,monospace;letter-spacing:1px;font-weight:700}
    .row{display:flex;gap:8px;align-items:center}
    .row-wrap{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .my-code-row{gap:12px;font-size:24px}
    input, select{flex:1;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);
          background:rgba(255,255,255,.04);color:var(--text);outline:none}
    input::placeholder{color:#9aa2d1} input:focus, select:focus{border-color:var(--accent)}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid transparent;
         background:linear-gradient(180deg,var(--accent),var(--accent2));color:#fff;font-weight:600;cursor:pointer}
    .btn:hover{filter:brightness(1.1)} .btn:active{transform:translateY(1px)}
    .btn-light{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.14)}
    .error{color:var(--danger);min-height:20px;margin-top:8px}
    .ok{color:var(--ok)}
    .chat-header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px}
    .chat{display:grid;grid-template-rows:auto auto 1fr auto;height:68vh}
    .messages{list-style:none;padding:0;margin:0;overflow-y:auto;border:1px solid rgba(255,255,255,.08);
              border-radius:12px;background:rgba(255,255,255,.03)}
    .msg{max-width:80%;margin:10px;padding:10px 12px;border-radius:14px;line-height:1.25;
         border:1px solid rgba(255,255,255,.08);box-shadow:0 6px 14px rgba(0,0,0,.2);word-wrap:break-word}
    .msg.me{margin-left:auto;background:rgba(92,124,250,.18)}
    .msg.other{margin-right:auto;background:rgba(255,255,255,.06)}
    .msg-time{display:block;margin-top:6px;font-size:12px;color:var(--muted);text-align:right}
    .msg img{max-width:320px;border-radius:10px;display:block}
    .send-row{display:flex;gap:8px;margin-top:10px}
    .hidden{display:none}
    .footer{text-align:center;color:var(--muted);margin-top:20px;font-size:12px}
    .small{font-size:12px;color:var(--muted)}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
  <main class="container">
    <h1>Pair Chat</h1>

    <!-- –¢–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥ -->
    <section class="card">
      <h2>–¢–≤–æ–π –∫–æ–¥</h2>
      <div class="row my-code-row">
        <span id="myCode" class="code">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
        <button id="copyBtn" class="btn">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
      <p class="hint">–û—Ç–ø—Ä–∞–≤—å —ç—Ç–æ—Ç 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –¥—Ä—É–≥—É. –ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —á–∞—Ç, –≤–≤–µ–¥–∏ –µ–≥–æ –∫–æ–¥ –Ω–∏–∂–µ.</p>
    </section>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –¥—Ä—É–≥—É –ø–æ –∫–æ–¥—É -->
    <section class="card">
      <h2>–ù–∞—á–∞—Ç—å —á–∞—Ç —Å –¥—Ä—É–≥–æ–º</h2>
      <form id="pairForm" class="row">
        <input id="friendCodeInput" maxlength="6" pattern="[0-9]{6}" placeholder="–ö–æ–¥ –¥—Ä—É–≥–∞ (6 —Ü–∏—Ñ—Ä)" required />
        <button class="btn" type="submit">–û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç</button>
      </form>
      <p id="pairError" class="error"></p>
    </section>

    <!-- –ß–∞—Ç -->
    <section id="chatSection" class="card chat hidden">
      <div class="chat-header">
        <div>–ß–∞—Ç —Å –∫–æ–¥–æ–º: <span id="peerCode" class="code"></span></div>
        <div id="lockState" class="code ok">üîí –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ</div>
        <button id="closeChatBtn" class="btn btn-light">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>

      <!-- TTL –≤—ã–±–æ—Ä (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1 —á–∞—Å) -->
      <div class="row-wrap" style="margin-bottom:8px">
        <label class="small nowrap" for="ttlSelect">–£–¥–∞–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑:</label>
        <select id="ttlSelect" style="max-width:240px">
          <option value="604800">7 –¥–Ω–µ–π</option>
          <option value="259200">3 –¥–Ω—è</option>
          <option value="25200">7 —á–∞—Å–æ–≤</option>
          <option value="3600" selected>1 —á–∞—Å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)</option>
        </select>
        <span id="ttlStatus" class="small"></span>
      </div>

      <ul id="messages" class="messages"></ul>

      <!-- –¢–µ–∫—Å—Ç + –∫–∞—Ä—Ç–∏–Ω–∫–∞ -->
      <form id="msgForm" class="send-row">
        <input id="msgInput" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off" />
        <input id="imgInput" type="file" accept="image/*" style="flex:0 0 auto; width:240px; padding:8px 10px" />
        <button class="btn" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        <button id="sendImgBtn" class="btn btn-light" type="button">–û—Ç–ø. —Ñ–æ—Ç–æ</button>
      </form>
    </section>

    <p class="footer">GitHub Pages + Firebase ‚Ä¢ E2E AES-GCM ‚Ä¢ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —à–∏—Ñ—Ä—É—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ ‚Ä¢ –ê–≤—Ç–æ-—É–¥–∞–ª–µ–Ω–∏–µ –ø–æ TTL</p>
  </main>

  <script type="module">
    // ===== Firebase =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, addDoc, collection,
             onSnapshot, serverTimestamp, query, orderBy, where, deleteDoc, Timestamp, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getBytes } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    // <<< –í–°–¢–ê–í–¨ –°–í–û–ô –ö–û–ù–§–ò–ì >>>
    const firebaseConfig = {
  apiKey: "AIzaSyDQJneytm9Zi2y0vK0i847qdeT2b_0awfA",
  authDomain: "pair-chat-7f1bf.firebaseapp.com",
  projectId: "pair-chat-7f1bf",
  storageBucket: "pair-chat-7f1bf.firebasestorage.app",
  messagingSenderId: "685488512637",
  appId: "1:685488512637:web:cb43fda988190144079b14",
  measurementId: "G-BDDLDDGP25"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const sto  = getStorage(app);

    // ===== UI refs =====
    const myCodeEl = document.getElementById("myCode");
    const copyBtn = document.getElementById("copyBtn");
    const pairForm = document.getElementById("pairForm");
    const friendCodeInput = document.getElementById("friendCodeInput");
    const pairErrorEl = document.getElementById("pairError");
    const chatSection = document.getElementById("chatSection");
    const peerCodeEl = document.getElementById("peerCode");
    const messagesEl = document.getElementById("messages");
    const msgForm = document.getElementById("msgForm");
    const msgInput = document.getElementById("msgInput");
    const imgInput = document.getElementById("imgInput");
    const sendImgBtn = document.getElementById("sendImgBtn");
    const closeChatBtn = document.getElementById("closeChatBtn");
    const lockStateEl = document.getElementById("lockState");
    const ttlSelect = document.getElementById("ttlSelect");
    const ttlStatus = document.getElementById("ttlStatus");

    // ===== State =====
    let currentUid = null;
    let myCode = null;
    let currentPairId = null;
    let unsubMessages = null;
    let unsubPair = null;
    let encKey = null; // CryptoKey AES-GCM
    let ttlSeconds = 3600; // default 1h

    // ===== Crypto helpers =====
    const te = new TextEncoder(); const td = new TextDecoder();
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const rand = (n) => crypto.getRandomValues(new Uint8Array(n));
    const bufToB64 = (b) => btoa(String.fromCharCode(...new Uint8Array(b)));
    const b64ToBuf = (s) => Uint8Array.from(atob(s), c => c.charCodeAt(0)).buffer;

    // –ü—Ä–æ—Å—Ç–∞—è –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–µ—Ä–∏–≤–∞—Ü–∏—è –∫–ª—é—á–∞ –∏–∑ pairId (–æ–±–∞ –∫–ª–∏–µ–Ω—Ç–∞ –≤—ã—á–∏—Å–ª—è—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤–æ)
    const APP_SALT = "pairchat:v1";
    async function deriveKeyFromPairId(pairId){
      const baseKey = await crypto.subtle.importKey("raw", te.encode(pairId), "PBKDF2", false, ["deriveKey"]);
      return await crypto.subtle.deriveKey(
        { name:"PBKDF2", salt: te.encode(APP_SALT), iterations: 200000, hash: "SHA-256" },
        baseKey,
        { name:"AES-GCM", length:256 },
        false,
        ["encrypt","decrypt"]
      );
    }

    async function encryptBytes(buf){
      if(!encKey) throw new Error("no-key");
      const iv = rand(12);
      const ct = await crypto.subtle.encrypt({name:"AES-GCM", iv}, encKey, buf);
      return { ct: new Uint8Array(ct), iv: new Uint8Array(iv.buffer) };
    }

    async function decryptBytes(ctU8, ivU8){
      const pt = await crypto.subtle.decrypt({name:"AES-GCM", iv:ivU8}, encKey, ctU8);
      return new Uint8Array(pt);
    }

    async function encryptString(plain){
      const { ct, iv } = await encryptBytes(te.encode(plain));
      return { ct: bufToB64(ct.buffer), iv: bufToB64(iv.buffer), v:1 };
    }

    async function decryptToString(ctB64, ivB64){
      const pt = await decryptBytes(new Uint8Array(b64ToBuf(ctB64)), new Uint8Array(b64ToBuf(ivB64)));
      return td.decode(pt);
    }

    function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));}
    function renderMyCode(code){ myCodeEl.textContent = code; }
    function clearMessages(){ messagesEl.innerHTML = ""; }
    function stopMessagesStream(){ if (unsubMessages){unsubMessages();unsubMessages=null;} if (unsubPair){unsubPair();unsubPair=null;} }
    function setLock(on){ lockStateEl.textContent = on ? "üîí –®–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ" : "üîì –ù–µ—Ç —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è"; lockStateEl.className = on ? "code ok" : "code"; }
    function generateCode(){ return String(Math.floor(100000 + Math.random()*900000)); }

    function ttlLabel(sec){
      const map = { 3600: "1 —á–∞—Å", 25200: "7 —á–∞—Å–æ–≤", 259200: "3 –¥–Ω—è", 604800: "7 –¥–Ω–µ–π" };
      return map[sec] || (sec + " c");
    }

    function addMessageItem(data){
      const { uid, ts, ct, iv, type, mime, storagePath, text } = data;
      const li = document.createElement("li");
      li.className = "msg " + (uid === currentUid ? "me" : "other");
      const time = ts?.toDate ? ts.toDate() : new Date();
      const hh = String(time.getHours()).padStart(2,"0"); const mm = String(time.getMinutes()).padStart(2,"0");

      if (type === "image" && storagePath && iv) {
        // –∑–∞–≥—Ä—É–∑–∏–º, —Ä–∞—Å—à–∏—Ñ—Ä—É–µ–º, –ø–æ–∫–∞–∂–µ–º
        (async () => {
          try{
            const bytes = await getBytes(ref(sto, storagePath));
            const pt = await decryptBytes(new Uint8Array(bytes), new Uint8Array(b64ToBuf(iv)));
            const blob = new Blob([pt], { type: mime || "image/jpeg" });
            const url = URL.createObjectURL(blob);
            li.innerHTML = `<div><img src="${url}" alt="image"/></div><span class="msg-time">${hh}:${mm}</span>`;
          }catch(e){
            li.innerHTML = `<div>üîí (–Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å/–∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)</div><span class="msg-time">${hh}:${mm}</span>`;
          }
        })();
      } else if (ct && iv) {
        decryptToString(ct, iv).then(t=>{
          li.innerHTML = `<div>${escapeHtml(t)}</div><span class="msg-time">${hh}:${mm}</span>`;
        }).catch(()=>{
          li.innerHTML = `<div>üîí (–Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å)</div><span class="msg-time">${hh}:${mm}</span>`;
        });
      } else if (text) {
        li.innerHTML = `<div>${escapeHtml(text)}</div><span class="msg-time">${hh}:${mm}</span>`;
      } else {
        li.innerHTML = `<div>[–ø—É—Å—Ç–æ]</div><span class="msg-time">${hh}:${mm}</span>`;
      }
      messagesEl.appendChild(li);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    async function ensureOwnCode(uid){
      const local = localStorage.getItem("pairchat_code");
      if (local) {
        const snap = await getDoc(doc(db, "codes", local));
        if (snap.exists() && snap.data().ownerUid === uid) return local;
      }
      for (let i=0;i<8;i++){
        const code = generateCode();
        try{
          await setDoc(doc(db, "codes", code), { ownerUid: uid, createdAt: serverTimestamp() });
          localStorage.setItem("pairchat_code", code);
          return code;
        }catch{ await sleep(30); }
      }
      throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ–∑–∂–µ.");
    }

    // === TTL ===
    async function saveTTL(seconds){
      ttlSeconds = seconds;
      if (!currentPairId) return;
      await setDoc(doc(db, "pairs", currentPairId), { ttlSeconds }, { merge:true });
      ttlStatus.textContent = `–ë—É–¥–µ–º —É–¥–∞–ª—è—Ç—å —Å—Ç–∞—Ä—à–µ: ${ttlLabel(ttlSeconds)}`;
    }

    async function cleanupOldMessages(){
      if (!currentPairId || !ttlSeconds) return;
      const cutoff = Timestamp.fromMillis(Date.now() - ttlSeconds*1000);
      // —É–¥–∞–ª—è–µ–º –ø–æ—Ä—Ü–∏—è–º–∏ –ø–æ 50, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å
      while (true) {
        const qOld = query(collection(db, "pairs", currentPairId, "messages"), where("ts","<",cutoff), orderBy("ts","asc"), limit(50));
        const snap = await getDocs(qOld);
        if (snap.empty) break;
        const batch = [];
        for (const d of snap.docs) batch.push(deleteDoc(d.ref));
        await Promise.all(batch);
        // –Ω–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞
        await sleep(100);
      }
    }

    // –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ —á–∏—Å—Ç–∏–º (–∫–∞–∂–¥—ã–µ 60—Å)
    setInterval(()=>cleanupOldMessages().catch(()=>{}), 60000);

    async function openChatWithCode(friendCode){
      pairErrorEl.textContent = "";
      if(!/^\d{6}$/.test(friendCode)){ pairErrorEl.textContent="–í–≤–µ–¥–∏—Ç–µ 6 —Ü–∏—Ñ—Ä."; return; }
      if(friendCode === myCode){ pairErrorEl.textContent="–ù–µ–ª—å–∑—è —á–∞—Ç–∏—Ç—å—Å—è —Å —Å–æ–±–æ–π :)"; return; }

      const friendSnap = await getDoc(doc(db, "codes", friendCode));
      if(!friendSnap.exists()){ pairErrorEl.textContent="–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ—Å–∏—Ç–µ –¥—Ä—É–≥–∞ –æ—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç."; return; }
      const friendUid = friendSnap.data().ownerUid;
      if(friendUid === currentUid){ pairErrorEl.textContent="–≠—Ç–æ –≤–∞—à –∫–æ–¥."; return; }

      const [aUid, bUid] = [currentUid, friendUid].sort();
      const pairId = `${aUid}_${bUid}`;
      currentPairId = pairId;

      // –ö–ª—é—á (–≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á—ë–Ω)
      encKey = await deriveKeyFromPairId(pairId);
      setLock(true);

      // –°–æ–∑–¥–∞–¥–∏–º/–æ–±–Ω–æ–≤–∏–º –ø–∞—Ä—É, –ø–æ–¥—Ç—è–Ω–µ–º TTL
      await setDoc(doc(db, "pairs", pairId), { aUid, bUid, createdAt: serverTimestamp(), ttlSeconds: ttlSeconds }, { merge:true });

      // —Å–ª—É—à–∞–µ–º —Å–∞–º pair, —á—Ç–æ–±—ã TTL —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–ª—Å—è –º–µ–∂–¥—É —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏
      if (unsubPair) { unsubPair(); }
      unsubPair = onSnapshot(doc(db, "pairs", pairId), (ds)=>{
        const data = ds.data() || {};
        if (data.ttlSeconds && data.ttlSeconds !== ttlSeconds) {
          ttlSeconds = data.ttlSeconds;
          ttlSelect.value = String(ttlSeconds);
          ttlStatus.textContent = `–ë—É–¥–µ–º —É–¥–∞–ª—è—Ç—å —Å—Ç–∞—Ä—à–µ: ${ttlLabel(ttlSeconds)}`;
        }
      });

      // –°–æ–æ–±—â–µ–Ω–∏—è
      if (unsubMessages) { unsubMessages(); }
      clearMessages();
      const qMsgs = query(collection(db, "pairs", pairId, "messages"), orderBy("ts","asc"));
      unsubMessages = onSnapshot(qMsgs, (snap)=>{ clearMessages(); snap.forEach(d=>addMessageItem(d.data())); });

      peerCodeEl.textContent = friendCode;
      chatSection.classList.remove("hidden");
      msgInput.focus();

      // —Å—Ç–∞—Ä—Ç–æ–≤–∞—è —á–∏—Å—Ç–∫–∞
      cleanupOldMessages().catch(()=>{});
    }

    async function sendText(text){
      if(!text || !currentPairId) return;
      const payload = await encryptString(text);
      await addDoc(collection(db, "pairs", currentPairId, "messages"), {
        uid: currentUid, ...payload, type: "text", ts: serverTimestamp()
      });
    }

    async function sendImage(file){
      if(!file || !currentPairId) return;
      if (file.size > 5*1024*1024) { pairErrorEl.textContent = "–ö–∞—Ä—Ç–∏–Ω–∫–∞ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∞—è (–º–∞–∫—Å. 5MB)."; return; }
      const buf = await file.arrayBuffer();
      const { ct, iv } = await encryptBytes(buf);

      const name = `${Date.now()}-${Math.random().toString(36).slice(2)}.${(file.name.split('.').pop()||'bin')}`;
      const path = `pairs/${currentPairId}/${currentUid}/${name}`;

      await uploadBytes(ref(sto, path), ct, { contentType: "application/octet-stream" });
      await addDoc(collection(db, "pairs", currentPairId, "messages"), {
        uid: currentUid,
        type: "image",
        storagePath: path,
        iv: bufToB64(iv.buffer),
        mime: file.type || "image/jpeg",
        ts: serverTimestamp()
      });
      imgInput.value = "";
    }

    // ===== Events =====
    copyBtn.addEventListener("click", async () => {
      try { await navigator.clipboard.writeText(myCode || ""); copyBtn.textContent="–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!"; setTimeout(()=>copyBtn.textContent="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å",1200); } catch {}
    });
    pairForm.addEventListener("submit", async (e)=>{ e.preventDefault(); await openChatWithCode((friendCodeInput.value||"").trim()); });
    msgForm.addEventListener("submit", async (e)=>{ e.preventDefault(); const t=(msgInput.value||"").trim(); if(t) await sendText(t); else if (imgInput.files?.[0]) await sendImage(imgInput.files[0]); msgInput.value=""; });
    sendImgBtn.addEventListener("click", async ()=>{ if (imgInput.files?.[0]) await sendImage(imgInput.files[0]); });
    ttlSelect.addEventListener("change", async ()=>{ await saveTTL(Number(ttlSelect.value)); });
    closeChatBtn.addEventListener("click", ()=>{ stopMessagesStream(); chatSection.classList.add("hidden"); currentPairId=null; encKey=null; setLock(true); });

    // ===== Bootstrap =====
    onAuthStateChanged(auth, async (user)=>{
      if(!user) return;
      currentUid = user.uid;
      try{ myCode = await ensureOwnCode(currentUid); renderMyCode(myCode); }
      catch(e){ pairErrorEl.textContent = e.message || String(e); }
    });

    signInAnonymously(auth).catch(err=>{
      document.getElementById("pairError").textContent = `Firebase Auth error: ${err.code}`;
      console.error(err);
    });

    // –¥–µ—Ñ–æ–ª—Ç TTL –Ω–∞ UI
    ttlSelect.value = "3600";
    ttlStatus.textContent = `–ë—É–¥–µ–º —É–¥–∞–ª—è—Ç—å —Å—Ç–∞—Ä—à–µ: ${ttlLabel(ttlSeconds)}`;
  </script>
</body>
</html>